<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Web Serial Barcode Scanner</title>
  <style>

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
    }
    button {
      margin: 10px 30px;
      /*float: right;*/
    }
    fieldset {
      border: 1px solid gray;
      margin-top: 10px;
    }
    label {
      display: flex;
      margin-top: 10px;
    }
    input {
      margin-left: 10px;
    }
    select {
      margin-left: 10px;
    }

    #status {
      font-size: 1.2em;
      padding: 10px;
      border-radius: 5px;
    }
    .input-group {
      margin: 10px;
    }
    .connected {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .scan-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .scan-results h2 {
      text-align: center;
      color: #333;
    }

    .data-columns {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .column {
      flex: 1;
      min-width: 280px;  /* Минимальная ширина столбца */
      max-width: 600px;  /* Максимальная ширина столбца */
    }

    .column h3 {
      margin: 0 0 10px 0;
      font-size: 1.2em;
      color: #444;
    }

    .column pre {
      border: 1px solid #ccc;
      padding: 12px;
      height: 300px;
      overflow-y: auto;
      margin: 0;
      background-color: #f9f9f9;
      font-size: 14px;
      white-space: pre-wrap; /* Перенос длинных строк */
      word-wrap: break-word;
    }
    button {
      margin-top: 10px;
    }
    input[type="text"] {
      width: 120px;
      margin-right: 10px;
    }
    #autoConnectStatus {
      margin-left: 10px;
      font-weight: bold;
    }
    .error-border {
      border-color: red !important;
    }
    /* список устройств */
    .clickable-count {
      cursor: pointer;
      text-decoration: underline;
      color: #0066cc;
      font-weight: bold;
    }

    .devices-list-container {
      position: relative;
      display: inline-block;
    }

    .devices-list {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-height: 600px;
      overflow-y: auto;
      padding: 10px;
      width: 550px;
      z-index: 100;
      display: none;
      margin-top: 5px;
    }

    .devices-list.show {
      display: block;
    }

    .vendor-section {
      margin-bottom: 15px;
    }

    .vendor-section:last-child {
      margin-bottom: 0;
    }

    .vendor-name {
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }

    .device-item {
      padding: 3px 0 3px 10px;
      border-left: 2px solid #4361ee;
      margin: 2px 0;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .remove-device {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      font-size: 14px;
      padding: 0 5px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .remove-device:hover {
      opacity: 1;
    }
  </style>
</head>
<body>
<h1>Web Serial Barcode Scanner</h1>
<!-- SupportedDevices -->
<div class="devices-list-container">
  <h3>
    Поддерживаемые устройства:
    <span id="supportedDevicesCount" class="clickable-count">0</span>
  </h3>
  <div id="supportedDevicesList" class="devices-list"></div>
</div>

<div class="devices-list-container">
  <h3>
    Пользовательские устройства:
    <span id="userDevicesCount" class="clickable-count">0</span>
  </h3>
  <div id="userDevicesList" class="devices-list"></div>
</div>
<!-- / SupportedDevices -->
<div>
  <button id="connectScanner">Подключить/Отключить сканер вручную</button>
</div>

<fieldset id="scannerSettings">
  <legend>Настройки сканера (com порта):</legend>
  <div class="input-group">
    <label>Интервал опроса COM порта
      <select id="interByteTimeoutSelect" name="interByteTimeoutSelect" class="scanner-options">
        <option>10</option>
        <option>30</option>
        <option>50</option>
        <option>100</option>
        <option>150</option>
        <option>200</option>
        <option>250</option>
        <option selected>300</option>
        <option>350</option>
        <option>400</option>
        <option>450</option>
        <option>500</option>
        <option>550</option>
        <option>600</option>
        <option>650</option>
        <option>700</option>
        <option>750</option>
        <option>800</option>
        <option>850</option>
        <option>900</option>
        <option>950</option>
        <option>1000</option>
      </select>
    </label>

    <label>Скорость передачи COM-порта
      <select id="baudRateSelect" name="baudRateSelect" class="scanner-options">
        <option>300</option>
        <option>1200</option>
        <option>2400</option>
        <option>4800</option>
        <option selected>9600</option>
        <option>19200</option>
        <option>38400</option>
        <option>57600</option>
        <option>115200</option>
      </select>
    </label>

  </div>
</fieldset>

<fieldset id="scannerAutoConnect">
  <legend>Авто-подключение <a href="#todo">известных</a> устройств: <input type="checkbox" id="autoConnectCheckbox">
    <span id="autoConnectStatus">Выключено</span></legend>
  <label> Интервал проверки подключенных устройств:
    <select id="reconnectDelaySelect" name="reconnectDelaySelect" class="scanner-options">
      <option>500</option>
      <option>1000</option>
      <option>2000</option>
      <option selected>3000</option>
      <option>5000</option>
      <option>10000</option>
      <option>50000</option>
      <option>100000</option>
    </select>
  </label>

  <label>Добавить по VID PID:</label>
  <label> VID (4 символа):
    <input id='scanner.vid' class="scanner-options" name="scanner.vid" pattern="[0-9A-F]{4}" minlength="4" maxlength="4" title="VID сканера" placeholder="например, 1A86">
  </label>
  <label> PID (4 символа):
    <input id='scanner.pid' class="scanner-options" name="scanner.pid" pattern="[0-9A-F]{4}" minlength="4" maxlength="4" title="PID сканера" placeholder="например, 5723">
  </label>
  <button id="addDevice">Добавить</button>
</fieldset>

<!-- Отображение статуса -->
<h3 id="status" class="disconnected">Сканер не подключен</h3>
<!-- Результаты сканирования: -->
<div class="scan-results">
  <h2>Результаты сканирования:</h2>
  <div class="data-columns">
    <div class="column">
      <h3>Отсканированные данные:</h3>
      <pre id="rawData"></pre>
    </div>
    <div class="column">
      <h3>Обработанные данные:</h3>
      <pre id="parsedData"></pre>
    </div>
  </div>
</div>

<script type="module">
  import { WebSerialBarcodeScanner } from '../../packages/core/src';
  import { BarcodeDataParser } from '../../packages/parser/src';

  navigator.serial.addEventListener('connect', e => {
    // Add |e.target| to the UI or automatically connect.
    console.log('e', e)
    console.log('e2', e.target.getInfo())

  });

  navigator.serial.addEventListener('disconnect', e => {
    // Add |e.target| to the UI or automatically connect.
    console.log('error event', e)

  });

  const barcodeDataParser = new BarcodeDataParser()
  const scanner = new WebSerialBarcodeScanner({
    barcodeDataParser,
    baudRate:  document.getElementById('baudRateSelect').value || 9600,
    reconnectDelay: document.getElementById('reconnectDelaySelect').value || 3000,
    interByteTimeout: document.getElementById('interByteTimeoutSelect').value || 300
  });


  scanner.addEventListener('data', (event) => {
  const { raw, data, type, parsed, error } = event.detail;
    document.getElementById('rawData').textContent += `${data}\n`;
  if (event.detail.type) {
            console.log(`Распарсенные данные (${type}):`, parsed);
            console.log('Raw:', raw);
            document.getElementById('parsedData').textContent += JSON.stringify(parsed) + '\n';
        }
  else {
            console.log('Не удалось распарсить:', event.detail);
            document.getElementById('parsedData').textContent += error+ '\n';
        }

  });

  scanner.addEventListener('status', (e) => {
       console.log(e?.detail?.message, e?.detail?.status)
    const statusElement = document.getElementById('status');
        statusElement.textContent = e.detail?.message;
        statusElement.className = '';
        statusElement.classList.add(e.detail?.status);
        if (e.detail?.status === 'disconnected' || e.detail?.message.startsWith('Ошибка')) {
          console.warn(e.detail.message);
        }
    }
  );

  document.getElementById('connectScanner').addEventListener('click', async () => {
    if (scanner.isConnected) {
      await scanner.disconnect();
    } else {
      await scanner.connect();
    }
  });

  document.getElementById('autoConnectCheckbox').addEventListener('change', (e) => {
    if (e.target.checked) {
      scanner.enableAutoConnect();
      document.getElementById('autoConnectStatus').textContent = 'Включено';
      document.getElementById('autoConnectStatus').style.color = 'green';
    } else {
      scanner.disableAutoConnect();
      document.getElementById('autoConnectStatus').textContent = 'Выключено';
      document.getElementById('autoConnectStatus').style.color = 'red';
    }
  });

  document.getElementById('addDevice').addEventListener('click', () => {
    const vidInput = document.getElementById('scanner.vid');
    const pidInput = document.getElementById('scanner.pid');
    const vid = vidInput.value.trim().toUpperCase();
    const pid = pidInput.value.trim().toUpperCase();

    // Валидация ввода
    if (!/^[0-9A-F]{4}$/i.test(vid)) {
      vidInput.classList.add('error-border');
      alert('VID должен содержать 4 шестнадцатеричных символа');
      return;
    } else {
      vidInput.classList.remove('error-border');
    }
    if (!/^[0-9A-F]{4}$/i.test(pid)) {
      pidInput.classList.add('error-border');
      alert('PID должен содержать 4 шестнадцатеричных символа');
      return;
    } else {
      pidInput.classList.remove('error-border');
    }

    if (scanner.addDevice(vid, pid)) {
      vidInput.value = '';
      pidInput.value = '';
    }
  });

  // Инициализация состояния автоподключения
  if (scanner.autoConnectEnabled) {
    document.getElementById('autoConnectCheckbox').checked = true;
    document.getElementById('autoConnectStatus').textContent = 'Включено';
    document.getElementById('autoConnectStatus').style.color = 'green';
    scanner.checkForDevices();
  } else {
    document.getElementById('autoConnectCheckbox').checked = false;
    document.getElementById('autoConnectStatus').textContent = 'Выключено';
    document.getElementById('autoConnectStatus').style.color = 'red';
  }

  // Обработчик для изменения интервала опроса COM порта
  document.getElementById('interByteTimeoutSelect').addEventListener('change', (event) => {
    scanner.interByteTimeout = parseInt(event.target.value, 10);
    if (scanner.isConnected) {
      console.log(`❗ ⚙️ Интервал опроса COM-порта изменен, переподключите устройство ❗`, scanner.interByteTimeout);
    }
  });

  // Обработчик для изменения скорости передачи COM-порта
  document.getElementById('baudRateSelect').addEventListener('change', (event) => {
    scanner.baudRate = parseInt(event.target.value, 10);
    if (scanner.isConnected) {
      console.log(`❗ ⚙️ Скорость передачи COM-порта изменена, переподключите устройство ❗`, scanner.baudRate);
    }
  });

  // Обработчик для изменения интервала проверки подключенных устройств
  document.getElementById('reconnectDelaySelect').addEventListener('change', (event) => {
    scanner.reconnectDelay = parseInt(event.target.value, 10);
    if (scanner.autoConnectEnabled) {
      scanner.disableAutoConnect();
      scanner.enableAutoConnect(); // Перезапуск автоподключения с новым интервалом
    }
  });

  /** список устройств */
// Функция для формирования списка устройств
  function buildDevicesList(container, devices, isUserDevices = false) {
    let html = '';
    Object.entries(devices).forEach(([vendorId, vendor]) => {
      html += `<div class="vendor-section">
                <div class="vendor-name">${vendor.vendorName} (VID: ${vendorId})</div>
                <div class="devices">`;
      Object.entries(vendor.devices).forEach(([productId, device]) => {
        html += `<div class="device-item">${device.name} (PID: ${productId})`;
        if (isUserDevices) {
          html += ` <button class="remove-device" data-vid="${vendorId}" data-pid="${productId}" title="Удалить устройство">❌</button>`;
        }
        html += `</div>`;
      });
      html += `</div></div>`;
    });
    container.innerHTML = html;

    // Добавляем обработчики для кнопок удаления
    if (isUserDevices) {
      container.querySelectorAll('.remove-device').forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const vid = e.target.dataset.vid;
          const pid = e.target.dataset.pid;
          console.log(`Удаление устройства (VID: ${vid}, PID: ${pid})`);
          if (confirm(`Удалить устройство (VID:0x${vid}, PID:0x${pid})?`)) {
            scanner.removeDevice(vid, pid);
          }
        });
      });
    }
  }

  // Обработчик клика по количеству поддерживаемых устройств
  document.getElementById('supportedDevicesCount').addEventListener('click', function(e) {
    e.stopPropagation();
    const listElement = document.getElementById('supportedDevicesList');
    const isVisible = listElement.classList.contains('show');

    // Скрыть все списки
    document.querySelectorAll('.devices-list').forEach(list => {
      list.classList.remove('show');
    });

    // Показать текущий список
    if (!isVisible) {
      // Заполнить список, если он пустой
      if (!listElement.innerHTML) {
        buildDevicesList(listElement, scanner.supportedDevices);
      }
      listElement.classList.add('show');
    }
  });

  // Обработчик клика по количеству пользовательских устройств
  document.getElementById('userDevicesCount').addEventListener('click', function(e) {
    e.stopPropagation();
    const listElement = document.getElementById('userDevicesList');
    const isVisible = listElement.classList.contains('show');

    // Скрыть все списки
    document.querySelectorAll('.devices-list').forEach(list => {
      list.classList.remove('show');
    });

    // Показать текущий список
    if (!isVisible) {
      // Заполнить список, если он пустой
      if (!listElement.innerHTML) {
        buildDevicesList(listElement, scanner.userDevices, true);
      }
      listElement.classList.add('show');
    }
  });

  // Скрыть списки при клике вне их области
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.devices-list-container')) {
      document.querySelectorAll('.devices-list').forEach(list => {
        list.classList.remove('show');
      });
    }
  });

  // Функция обновления счетчиков устройств
  function updateDevicesCount() {
    const supportedCount = Object.values(scanner.supportedDevices).reduce((count, vendor) =>
            count + Object.keys(vendor.devices).length, 0);
    document.getElementById('supportedDevicesCount').textContent = supportedCount;

    const userCount = Object.values(scanner.userDevices).reduce((count, vendor) =>
            count + Object.keys(vendor.devices).length, 0);
    document.getElementById('userDevicesCount').textContent = userCount;
  }

  // Инициализация счетчиков
  updateDevicesCount();

  // Обновление счетчиков при добавлении устройств
  scanner.addEventListener('status', (e) => {
    if (e.detail.message && (e.detail.message.includes('добавлено') ||
            e.detail.message.includes('удалено'))) {
      updateDevicesCount();

      // Перестраиваем списки, если они открыты
      const supportedList = document.getElementById('supportedDevicesList');
      const userList = document.getElementById('userDevicesList');

      if (supportedList.classList.contains('show')) {
        supportedList.innerHTML = '';
        buildDevicesList(supportedList, scanner.supportedDevices);
      }

      if (userList.classList.contains('show')) {
        userList.innerHTML = '';
        buildDevicesList(userList, scanner.userDevices, true); // Убедитесь, что передаём true для пользовательских устройств
      }
    }
  });

  // Добавляем отдельный обработчик для события обновления пользовательских устройств
  scanner.addEventListener('user-devices-updated', () => {
    updateDevicesCount();

    // Перестраиваем список пользовательских устройств, если он видим
    const userList = document.getElementById('userDevicesList');
    if (userList.classList.contains('show')) {
      userList.innerHTML = '';
      buildDevicesList(userList, scanner.userDevices, true);
    }
  });
  
  
</script>

</body>
</html>